name: Deploy to VM

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:

  deploy:
    name: ðŸš€ Clone, Build & Deploy on VM
    runs-on: ubuntu-latest

    steps:
      - name: â¬‡ï¸ Checkout repository
        uses: actions/checkout@v4

      # â”€â”€ Install Ansible on the GitHub runner â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ðŸ Install Ansible
        run: |
          python3 -m pip install --upgrade pip
          pip install ansible

      - name: ðŸ“¦ Install Ansible Galaxy collections
        run: |
          ansible-galaxy collection install -r requirements.yml

      # â”€â”€ Write SSH private key so Ansible can reach the VM â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ðŸ” Configure SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.VM_SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ secrets.VM_HOST }} >> ~/.ssh/known_hosts

      # â”€â”€ Write inventory pointing at the real VM â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ðŸ“ Generate Ansible inventory
        run: |
          cat > inventory.ini <<EOF
          [servers]
          ${{ secrets.VM_HOST }} ansible_user=${{ secrets.VM_USER }} ansible_ssh_private_key_file=~/.ssh/deploy_key

          [servers:vars]
          ansible_python_interpreter=/usr/bin/python3
          ansible_ssh_common_args='-o StrictHostKeyChecking=no'
          EOF

      # â”€â”€ Run the Ansible deploy playbook â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ðŸŽ¯ Run Ansible deploy playbook
        run: |
          ansible-playbook ansible/deploy.yml \
            -i inventory.ini \
            --extra-vars "repo_url=${{ github.server_url }}/${{ github.repository }} repo_branch=${{ github.ref_name }} commit_sha=${{ github.sha }}" \
            -v

      # â”€â”€ Smoke test â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ðŸ” Smoke test â€” verify HTTP 200
        run: |
          sleep 5
          STATUS=$(curl -o /dev/null -s -w "%{http_code}" http://${{ secrets.VM_HOST }}:80)
          if [ "$STATUS" != "200" ]; then
            echo "âŒ HTTP $STATUS â€” deployment may have failed."
            exit 1
          fi
          echo "âœ… App is live at http://${{ secrets.VM_HOST }} (HTTP $STATUS)"